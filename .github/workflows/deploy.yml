name: Build and Deploy

on:
  push:
    branches:
      - main
  repository_dispatch:

jobs:
  Build-and-Deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - uses: actions/checkout@v4

      # âš™ï¸ Node.js 16 (Nuxt2å¯¾å¿œ)
      - uses: actions/setup-node@v4
        with:
          node-version: 16

      # âš¡ï¸ Yarnä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - uses: actions/cache@v3
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      # ğŸ” Secretsã‹ã‚‰.envç”Ÿæˆ
      - name: Create .env file
        run: |
          echo "NUXT_ENV_SPACE_ID=${{ secrets.NUXT_ENV_SPACE_ID }}" >> .env
          echo "NUXT_ENV_CTF_ACCESS_TOKEN=${{ secrets.NUXT_ENV_CTF_ACCESS_TOKEN }}" >> .env
          echo "NUXT_ENV_BASE_URL=${{ secrets.NUXT_ENV_BASE_URL }}" >> .env

      # ğŸ—ï¸ Nuxt 2 ãƒ“ãƒ«ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
      - name: Install dependencies and build
        run: |
          yarn install --production
          yarn generate

      # ğŸ“¦ æˆæœç‰©ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆdistã®ä¸­èº«ã ã‘ï¼‰
      - name: Archive build files
        run: tar -czf dist.tar.gz -C dist .

      # ğŸš€ Lightsailã¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ/var/www/html ã«ç›´æ¥å±•é–‹ï¼‰
      - name: Deploy to AWS Lightsail
        run: |
          echo "${{ secrets.SERVER_KEY }}" > aws_lightsail_key
          chmod 600 aws_lightsail_key
          scp -i aws_lightsail_key -o StrictHostKeyChecking=no dist.tar.gz \
            ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/
          ssh -i aws_lightsail_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} \
            "
            mkdir -p /var/www/html && \
            find /var/www/html -mindepth 1 -delete && \
            tar -xzf /tmp/dist.tar.gz -C /var/www/html && \
            rm /tmp/dist.tar.gz
            "

      # âœ… æˆåŠŸé€šçŸ¥
      - name: Notify Slack (success)
        if: ${{ success() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: good
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: 'app-website-nislab'
          SLACK_ICON: https://s3-us-west-2.amazonaws.com/slack-files2/avatars/2021-07-06/2257469713729_06357f0ef4a522dfb049_72.png
          SLACK_USERNAME: 'NISLAB GitHub Actions'
          SLACK_TITLE: "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          SLACK_MESSAGE: |
            NISLAB HPã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼
            æ›´æ–°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
            NISLAB HP: https://nislab.doshisha.ac.jp/

      # âŒ å¤±æ•—é€šçŸ¥
      - name: Notify Slack (failure)
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: danger
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: 'app-website-nislab'
          SLACK_ICON: https://s3-us-west-2.amazonaws.com/slack-files2/avatars/2021-07-06/2257469713729_06357f0ef4a522dfb049_72.png
          SLACK_USERNAME: 'NISLAB GitHub Actions'
          SLACK_TITLE: "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          SLACK_MESSAGE: |
            NISLAB HPã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
            ãƒ­ã‚°ã®è©³ç´°ã¯ä¸Šè¨˜ã®ã€ŒActions URLã€ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
            NISLAB HP: https://nislab.doshisha.ac.jp/
