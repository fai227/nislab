name: Build and Deploy

on:
  push:
    branches:
      - main
  repository_dispatch:

jobs:
  Build-and-Deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© ãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—
      - uses: actions/checkout@v4

      # âš™ï¸ Node.js 16 (Nuxt2å¯¾å¿œ)
      - uses: actions/setup-node@v4
        with:
          node-version: 16

      # âš¡ï¸ Yarnä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - uses: actions/cache@v3
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      # ğŸ” Secrets ã‹ã‚‰ .env ã‚’ç”Ÿæˆ
      - name: Create .env file
        run: |
          echo "NUXT_ENV_SPACE_ID=${{ secrets.NUXT_ENV_SPACE_ID }}" >> .env
          echo "NUXT_ENV_CTF_ACCESS_TOKEN=${{ secrets.NUXT_ENV_CTF_ACCESS_TOKEN }}" >> .env
          echo "NUXT_ENV_BASE_URL=${{ secrets.NUXT_ENV_BASE_URL }}" >> .env

      # ğŸ—ï¸ Nuxt 2 ãƒ“ãƒ«ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
      - name: Install dependencies and build
        run: |
          yarn install --production
          yarn generate --fail-on-error --quiet false

      # ğŸ“¦ æˆæœç‰©ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      - name: Archive build files
        run: tar -czf dist.tar.gz ./dist

      # ğŸš€ Lightsailã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to AWS Lightsail
        run: |
          echo "${{ secrets.SERVER_KEY }}" > aws_lightsail_key
          chmod 600 aws_lightsail_key
          scp -i aws_lightsail_key -o StrictHostKeyChecking=no dist.tar.gz \
            ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:/tmp/
          ssh -i aws_lightsail_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} \
            "mkdir -p /var/www/html/nislab/dist && cd /var/www/html/nislab/dist && rm -rf ./* && tar -xzf /tmp/dist.tar.gz -C /var/www/html/nislab/dist && rm /tmp/dist.tar.gz"

      # âœ… æˆåŠŸé€šçŸ¥
      - name: Notify Slack (success)
        if: ${{ success() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: good
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: 'app-website-nislab'
          SLACK_ICON: https://s3-us-west-2.amazonaws.com/slack-files2/avatars/2021-07-06/2257469713729_06357f0ef4a522dfb049_72.png
          SLACK_USERNAME: 'NISLAB GitHub Actions'
          SLACK_TITLE: "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ"
          SLACK_MESSAGE: |
            Nuxt 2 ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒ **æˆåŠŸ** ã—ã¾ã—ãŸ ğŸ‰  
            ãƒ–ãƒ©ãƒ³ãƒ: `${{ github.ref_name }}`  
            ã‚³ãƒŸãƒƒãƒˆ: `${{ github.sha }}`  
            å®Ÿè¡Œè€…: `${{ github.actor }}`  

      # âŒ å¤±æ•—é€šçŸ¥
      - name: Notify Slack (failure)
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: danger
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: 'app-website-nislab'
          SLACK_ICON: https://s3-us-west-2.amazonaws.com/slack-files2/avatars/2021-07-06/2257469713729_06357f0ef4a522dfb049_72.png
          SLACK_USERNAME: 'NISLAB GitHub Actions'
          SLACK_TITLE: "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
          SLACK_MESSAGE: |
            ãƒ‡ãƒ—ãƒ­ã‚¤ãŒ **å¤±æ•—** ã—ã¾ã—ãŸ âš ï¸  
            ãƒ–ãƒ©ãƒ³ãƒ: `${{ github.ref_name }}`  
            ã‚³ãƒŸãƒƒãƒˆ: `${{ github.sha }}`  
            å®Ÿè¡Œè€…: `${{ github.actor }}`  
            è©³ç´°ãƒ­ã‚°: [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
